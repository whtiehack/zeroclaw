name: Workflow Sanity

on:
    pull_request:
        paths:
            - ".github/workflows/**"
            - ".github/*.yml"
            - ".github/*.yaml"
    push:
        paths:
            - ".github/workflows/**"
            - ".github/*.yml"
            - ".github/*.yaml"

concurrency:
    group: workflow-sanity-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: core.hooksPath
    GIT_CONFIG_VALUE_0: /dev/null


jobs:
    no-tabs:
        runs-on: [self-hosted, aws-india]
        timeout-minutes: 10
        steps:
            - name: Normalize git global hooks config
              shell: bash
              run: |
                  set -euo pipefail
                  git config --global --unset-all core.hooksPath || true

            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Fail on tabs in workflow files
              shell: bash
              run: |
                  set -euo pipefail
                  python3 - <<'PY'
                  from __future__ import annotations

                  import pathlib
                  import sys

                  root = pathlib.Path(".github/workflows")
                  bad: list[str] = []
                  for path in sorted(root.rglob("*.yml")):
                    if b"\t" in path.read_bytes():
                      bad.append(str(path))
                  for path in sorted(root.rglob("*.yaml")):
                    if b"\t" in path.read_bytes():
                      bad.append(str(path))

                  if bad:
                    print("Tabs found in workflow file(s):")
                    for path in bad:
                      print(f"- {path}")
                    sys.exit(1)
                  PY

    actionlint:
        runs-on: [self-hosted, aws-india]
        timeout-minutes: 10
        steps:
            - name: Normalize git global hooks config
              shell: bash
              run: |
                  set -euo pipefail
                  git config --global --unset-all core.hooksPath || true

            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Install actionlint binary
              shell: bash
              run: |
                  set -euo pipefail
                  version="1.7.11"
                  arch="$(uname -m)"
                  case "$arch" in
                    x86_64|amd64) archive="actionlint_${version}_linux_amd64.tar.gz" ;;
                    aarch64|arm64) archive="actionlint_${version}_linux_arm64.tar.gz" ;;
                    *)
                      echo "::error::Unsupported architecture: ${arch}"
                      exit 1
                      ;;
                  esac

                  curl -fsSL \
                    -o "$RUNNER_TEMP/actionlint.tgz" \
                    "https://github.com/rhysd/actionlint/releases/download/v${version}/${archive}"
                  tar -xzf "$RUNNER_TEMP/actionlint.tgz" -C "$RUNNER_TEMP" actionlint
                  chmod +x "$RUNNER_TEMP/actionlint"
                  echo "$RUNNER_TEMP" >> "$GITHUB_PATH"
                  "$RUNNER_TEMP/actionlint" -version

            - name: Lint GitHub workflows
              shell: bash
              run: actionlint -color
